{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block page_title %}CommCare Forms{% endblock %}

{% block content %}


    <img src="{{ STATIC_URL }}/img/commcare_logo_white.png">
    <p>Get access to your commcare data:</p>
    {% crispy form %}
    {% if auth == 1%} <!-- link to password -->
      <p>If you wish to instead login using your password click <a href="/commcare/passform/">here</a>. This will not save your login information for next time and prevent Tola from being able to update your table. </p>
    {% elif auth == 2 %} <!-- link to authorization -->
      <!-- <p>If you wish to instead login using your authorization token click <a href="/commcare/">here</a>. This will not save your login information for next time and prevent Tola from being able to update your table. </p> -->
    {% else %} <!-- link to logout -->
      <p> You can also <a href="/commcare/logout/">Logout</a> of this CommCare account. </p>
    {% endif %}


    <!-- Modal -->
    <div id="progress_modal" class="modal fade" role="dialog">
      <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Your data is being fetched. This may take a while</h4>
          </div>
          <div class="modal-body">
            <!-- <div id="progress_number">0/{{entries}} downloaded</div> -->
            <div class="col-xs-12 col-sm-12 progress-container">
                <div class="progress progress-striped active">
                    <div class="progress-bar" style="width:0%"></div>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
{% endblock content %}

{% block extra_js_in_body %}
    <script type="text/javascript">
        $(document).ready(function() {

            // If the form is returned with errors, make sure the appropriate
            // text input boxes are displayed.
            var downloadType = $("input[type=radio][name=download_type]");
            if ($("#id_download_type_1").attr("checked") == "checked") {
                $("#div_id_commcare_report_name").show();
                $("#div_id_commcare_form_name").hide();
            }
            // else if ($("#id_download_type_2").attr("checked") == "checked") {
            //     $("#div_id_commcare_report_name").hide();
            //     $("#div_id_commcare_form_name").show();
            // }
            else {
                $("#div_id_commcare_report_name").hide();
                $("#div_id_commcare_form_name").hide();
            }

            if ($("#id_silo").val() == -1) {
                $("#div_id_new_table_name").show();
            }
            else {
                $("#div_id_commcare_form_name").hide();
            }


            //Reveal the new table name input only if they have chosen to add a silo
            $("#id_silo").on("change", function() {
                if ($("#id_silo").val() == "-1"){
                  $("#div_id_new_table_name").show();
                  $("#id_new_table_name").focus();
                }
                else {
                  $("#div_id_new_table_name").hide();
                }
            });

            // Once the project has been specified (or if it's part of the
            // querystring because the user just provided their API key),
            // we can retrieve the list of reports from CommCare.
            // Doing it here rather than on radio button avoids doing an api
            // call on each radio select.
            base_url = '/commcare/report_names/?project=';
            $('input[id="id_project"]').on("change", function() {
                url = base_url + $('#' + this.id).val();
                getReportNames(url)
            });

            programMatch = window.location.href.match(/project=([^\&]+)/)
            if (programMatch) {
                url = base_url + programMatch[1];
                getReportNames(url)
            }
        });

        // Reveal the appropriate input field; depends on the download type
        // selected by the user.
        $("input[type=radio][name=download_type]").on("change", function(){
            if (this.value == 'commcare_report'){
                $("#div_id_commcare_report_name").show();
                $("#div_id_commcare_form_name").hide();
                $("#id_commcare_report_name").focus();
            }
            else if (this.value == 'commcare_form') {
              $("#div_id_commcare_form_name").show();
              $("#div_id_commcare_report_name").hide();
              $("#id_commcare_form_name").focus();
            }
            else {
              $("#div_id_commcare_report_name").hide();
              $("#div_id_commcare_form_name").hide();
            }
        });

        // Use a CommCare API to get the report names for the dropdown
        var getReportNames = function(url){
            $.ajax({
                url: url,
                type: "GET",
                // headers: headers,
                dataType: "JSON",
                complete: function(data, status) {
                    if (status == "success") {
                        var options = ['<option value=default>Select a Report</option>'];
                        $.each(data.responseJSON, function (id, name) {
                            options.push('<option value=' + id + '>' + name + '</option>');
                        });
                        $('#id_commcare_report_name').html(options.join('\n'));
                    } else {
                        console.log("something weird happened");
                    }
                }
            });
        };

    </script>
{% endblock %}
