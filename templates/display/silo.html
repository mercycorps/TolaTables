{% extends "base.html" %}


{% block page_title %}<center> <a href="/silo_edit/{{ silo.id }}">{{ silo.name }}</a>
    <br /><small><p>{{ silo.description|default:"" }}</p></small></center>
{% endblock %}

{% block content %}


    <div class="modal fade" tabindex="-1" role="dialog" id="repeats_modal">
        <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Repeats</h4>
            </div>
            <div class="modal-body" id="repeats_modal_body">
                <p>One fine body&hellip;</p>
            </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div>
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active">
                <a href="#sources" aria-controls="sources" role="tab" data-toggle="tab">Sources</a>
            </li>

            <li role="presentation">
                <a href="#options" aria-controls="options" role="tab" data-toggle="tab">Options</a>
            </li>
            <li role="presentation">
                <a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Profile</a>
            </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade in active" id="sources">
                <p>Sources go here ...</p>
            </div>
            <div role="tabpanel" class="tab-pane" id="options">
                <p>Options go here</p>
            </div>
            <div role="tabpanel" class="tab-pane" id="profile">
                {% for col in cols %}
                    <a class="toggle-viz" data-column="{{forloop.counter0}}">{{col}}</a>
                {% endfor %}
            </div>
        </div>
    </div>
    <br />

    <table id="data_table" class="display table-hover table table-striped table-bordered" cellspacing="0"
    width="100%">
        <thead>
            {% for c in cols %}
                <th>{{c}}</th>
            {% endfor %}
        </thead>
    </table>
{% endblock content %}


{% block extra_js_in_body %}
    <script type="text/javascript">
        $(document).ready(function() {
            var data = $.parseJSON(`{{ data|safe }}`);
            var cols = [];

            $("#data_table").find("th").each(function(i){
                if (i == 0) {
                    // make the first col have a set width and non-sortable
                    cols.push({"data": $(this).text(), "orderable": false , "width": "45px"});
                } else {
                    cols.push({
                        "data": $(this).text(),
                        // Use the cell render function to return "repeats if the value is an array"
                        "render": function(data, type, row) {
                            if (jQuery.type(data) == "array" ) {
                                return "repeats...";
                            } else {
                                return data;
                            }
                        }
                    });
                }
            })
            /*
            var mydata = [];
            $.each(data, function(i,row){
                mydata.push({});
                var r = mydata.length -1;
                $.each(row, function(k,v){
                    if (jQuery.type(v) == "object") {
                        var d = new Date(0);
                        d.setUTCSeconds(v['$date']/1000);
                        mydata[r][k] = d.toDateString();
                    } else {
                        mydata[r][k] = v;
                    }
                })
            });
            console.log(mydata);
            */
            var silo_table = $('#data_table').DataTable({
                stateSave: false, // save table state in local cache
                "ordering": true,
                "order": [], // show rows as they are read. To set order: [[1, "asc"]]
                "pageLength": 50,
                "data": data,
                "columns": cols,

            });
            var data = undefined;
            $('#data_table tbody').on( 'click', 'td', function () {
                var cell = silo_table.cell( this );
                var table = '<table class="table table-bordered table-hover table-striped" width="100%" cellspacing="0"><tr>';
                data = cell.data();
                //cell.data( "repeats" ).draw();
                if (jQuery.type(data) == "object") {
                    data = data[0];
                }

                if (jQuery.type(data) == "array") {
                    var column_names = [];
                    // First get all of the column names in this array
                    $.each(data, function(i,row){
                        $.each(row, function(c, v){
                            if (jQuery.inArray(c, column_names) < 0) {
                                column_names.push(c);
                            }
                        });
                    });
                    // Now use the column names to populate the table's header row
                    $.each(column_names, function(i, col){
                        col = col.split("/");
                        table += "<th>../" + col[col.length-1] + "</th>";
                    });
                    table += "</tr>";

                    // now populate the remaining data rows for the table
                    $.each(data, function(i,row){
                        table += "<tr>";
                        if (jQuery.type(row) == "object") {
                           $.each(row, function(c, v){
                                table += "<td>" + v + "</td>";
                                //console.log("c: " + c + " v: " + v);
                           });
                        }
                        table += "</tr>";
                    });
                    table += "</table>";
                    //set the table to be the html content of the modal's body
                    $("#repeats_modal_body").html(table);
                    $('#repeats_modal').modal("show");
                }
            });

            // toggles tables' column visibility
            $('a.toggle-viz').on('click', function(e){
                e.preventDefault();
                var column = silo_table.column($(this).attr('data-column') );
                column.visible( ! column.visible() );
            });

            /*
            console.log( 'Table\'s column visibility are set to: '+silo_table.columns().visible().join(', ') );
            $.each(silo_table.columns(), function(i,col){
                console.log("i="+i + " " + col);
            });
            */
        });
    </script>


{% endblock extra_js_in_body %}